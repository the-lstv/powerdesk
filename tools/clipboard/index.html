<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Base -->
    <link rel="stylesheet" href="../../assets/css/base.css">
    <script defer src="../../assets/js/base.js"></script>
    <link rel="stylesheet" href="../../assets/icons/index.css">

    <!-- Own resources -->
    <link rel="stylesheet" href="style.css">
    <script defer src="script.js"></script>

    <!-- LS -->
    <script src="../../assets/ls/bundle.js"></script>
    <link rel="stylesheet" href="../../assets/ls/bundle.css">

</head>

<body ls ls-style="flat" ls-accent="auto" class="level-1 force-shadow">

    <div id="wrapper">

        <div id="main-background">
            <div id="main">
                <div id="handle">
                    <div></div>
                </div>

                <ls-tabs id="content">
                    <ls-tab id="clipboardManager" tab-title="<i class='bi-clipboard'></i>">
                        <ls-div class="buttons">
                            <h3 class="title">Clipboard</h3>
                            <button class="elevated pill" onclick="clearAll()">Clear all</button>
                        </ls-div>

                        <div id="clipboardHistory"></div>
                    </ls-tab>

                    <ls-tab id="emojiPicker" tab-title="<i class='bi-emoji-smile'></i>">
                        <ls-div class="buttons">
                            <h3 class="title">Emoji</h3>
                            <input type="text" id="emojiSearch" placeholder="Search emoji...">
                        </ls-div>

                        <ls-div id="emojiCategories"></ls-div>

                        <div id="emojiList"></div>
                        
                        <!-- Temporary hardcoded list because i am lazy -->
                        <script>
                            const emojiList = document.getElementById('emojiList');
                            const emojiCategoriesContainer = document.getElementById('emojiCategories');

                            const emojiCategories = require('./emojis.json');

                            emojiCategories.forEach(category => {

                                category.containerElement = N("div", {
                                    class: "emoji-category",
                                    id: "category-" + category.slug
                                });

                                category.titleElement = N("h3", {
                                    class: "category-title",
                                    textContent: category.name
                                });

                                emojiCategoriesContainer.appendChild(N("button", {
                                    class: "category-button",
                                    inner: N("i", { class: "bi-" + category.icon }),
                                    onclick: () => {
                                        category.containerElement.scrollIntoView({ behavior: "smooth", block: "start" });
                                    }
                                }));

                                category.containerElement.appendChild(category.titleElement);
                                emojiList.appendChild(category.containerElement);

                                category.emojis.forEach(emoji => {
                                    const button = N("button", {
                                        class: "emoji circle",
                                        textContent: emoji.emoji,
                                        onclick: () => copyPaste(emoji.emoji),
                                        title: emoji.name
                                    });

                                    emoji.element = button;
                                    emoji.searchTag = emoji.slug.toLowerCase().replace(/[^a-z0-9]/g, '');
                                    category.containerElement.appendChild(button);
                                });

                            });

                            function searchEmoji(query) {
                                query = query.toLowerCase().replace(/[^a-z0-9]/g, '');

                                emojiCategories.forEach(category => {
                                    let resultCount = 0;

                                    category.emojis.forEach(emoji => {
                                        if (emoji.searchTag.includes(query)) {
                                            emoji.element.style.display = "inline-block";
                                            resultCount++;
                                        } else {
                                            emoji.element.style.display = "none";
                                        }
                                    });

                                    if (resultCount > 0) {
                                        category.containerElement.style.display = "flex";
                                    } else {
                                        category.containerElement.style.display = "none";
                                    }
                                });
                            }

                            // Add event listener for emoji search input
                            document.getElementById('emojiSearch').addEventListener('input', (event) => {
                                searchEmoji(event.target.value);
                            });
                        </script>
                    </ls-tab>

                    <ls-tab tab-title="<i class='bi-file-earmark-lock'></i>" id="lockedFoldersTab">
                        <ls-div class="buttons">
                            <h3 class="title">Locked folders</h3>
                            <button class="elevated pill" id="lockedFoldersRefresh">Refresh</button>
                        </ls-div>

                        <div id="lockedFolders"></div>
                    </ls-tab>

                    <ls-tab tab-title="<i class='bi-key'></i>" id="tokenStorageTab">
                        <ls-div class="buttons">
                            <h3 class="title">Token storage</h3>
                        </ls-div>

                        <form class="buttons" onsubmit="addToken(this); return false;">
                            <ls-group>
                                <input type="text" id="tokenTitle" placeholder="Title">
                                <input type="text" id="tokenValue" placeholder="Value">
                                <button class="elevated" type="submit"><i class="bi-plus-lg"></i></button>
                            </ls-group>
                        </form>

                        <div id="tokenList"></div>

                        <span style="color: gray; font-size: small; text-align: center; padding: 4px 0">Hold shift while clicking <i class="bi-clipboard"></i> to paste</span>

                        <script>
                            let tokens;

                            function refreshTokens() {
                                tokens = JSON.parse(localStorage.getItem('tokens') || '[]');
                                const tokenContainer = document.getElementById('tokenList');
                                tokenContainer.innerHTML = '';

                                if (tokens && tokens.length > 0) {
                                    tokens.forEach(token => {
                                        const tokenElement = N({
                                            class: "tokenContainer",
                                            inner: [
                                                N([
                                                    N({
                                                        class: "tokenTitle",
                                                        inner: token.title
                                                    }),
                                                    N({
                                                        class: "tokenValue",
                                                        inner: token.value.trim().length > 5 ? token.value.trim().substring(0, 5) + "..." : token.value.trim(),
                                                    }),
                                                ]),

                                                N("ls-group", [
                                                    N("button", {
                                                        class: "elevated",
                                                        title: "Copy",
                                                        inner: N("i", { class: "bi-clipboard" }),
                                                        onclick() {
                                                            if (event.shiftKey) {
                                                                copyPaste(token.value);
                                                                return;
                                                            }

                                                            LS.Util.copy(token.value);
                                                            LS.Toast.show("Copied to clipboard", { timeout: 1000 });
                                                        }
                                                    }),
                                                    N("button", {
                                                        class: "elevated warning",
                                                        title: "Delete",
                                                        inner: N("i", { class: "bi-trash" }),
                                                        onclick() {
                                                            tokens = tokens.filter(t => t !== token);
                                                            localStorage.setItem('tokens', JSON.stringify(tokens));
                                                            refreshTokens();
                                                        }
                                                    })
                                                ])
                                            ]
                                        });

                                        tokenContainer.appendChild(tokenElement);
                                    });
                                }
                            }

                            refreshTokens();

                            function addToken(form) {
                                const title = form.tokenTitle.value.trim();
                                const value = form.tokenValue.value.trim();

                                if (title && value) {
                                    tokens.push({ title, value });
                                    localStorage.setItem('tokens', JSON.stringify(tokens));
                                    form.reset();
                                    refreshTokens();
                                }
                            }
                        </script>

                        <style>
                            .tokenContainer {
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                padding: 8px 10px;
                                border-bottom: 1px solid var(--elevate-2);
                            }

                            .tokenValue {
                                color: var(--elevate-3);
                                font-family: monospace;
                            }

                            #tokenList {
                                padding: 10px;
                                overflow: auto;
                            }
                        </style>
                    </ls-tab>

                    <ls-tab tab-title="<i class='bi-shield-lock'></i>" id="totpManagerTab">
                        <ls-div class="buttons">
                            <h3 class="title">TOTP Manager</h3>
                            <button class="elevated pill" id="totpAddBtn">Add TOTP</button>
                        </ls-div>

                        <form id="totpForm" class="buttons" style="display:none;" onsubmit="addTotp(this); return false;">
                            <ls-group>
                                <input type="text" id="totpLabel" placeholder="Label" required>
                                <input type="text" id="totpSecret" placeholder="Secret" required>
                                <button class="elevated" type="submit"><i class="bi-plus-lg"></i></button>
                            </ls-group>
                        </form>

                        <div id="totpList"></div>

                        <script>
                            const totpGenerator = require("totp-generator").TOTP;

                            let totps = [];

                            function refreshTotps() {
                                totps = JSON.parse(localStorage.getItem('totps') || '[]');
                                const list = document.getElementById('totpList');
                                list.innerHTML = '';

                                if (totps.length === 0) {
                                    list.innerHTML = "<div style='color:gray;text-align:center;'>No TOTP entries</div>";
                                    return;
                                }

                                totps.forEach((entry, idx) => {
                                    const container = N({
                                        class: "tokenContainer",
                                        inner: [
                                            N([
                                                N({ class: "tokenTitle", inner: entry.label }),
                                                N({ class: "tokenValue", id: "totpCode" + idx, inner: "------" }),
                                            ]),
                                            N("ls-group", [
                                                N("button", {
                                                    title: "Copy",
                                                    inner: N("i", { class: "bi-clipboard" }),
                                                    onclick() {
                                                        const code = document.getElementById("totpCode" + idx).textContent;

                                                        if (event.shiftKey) {
                                                            copyPaste(code);
                                                            return;
                                                        }

                                                        LS.Util.copy(code);
                                                        LS.Toast.show("TOTP copied", { timeout: 1000 });
                                                    }
                                                }),
                                                N("button", {
                                                    class: "warning",
                                                    title: "Delete",
                                                    inner: N("i", { class: "bi-trash" }),
                                                    onclick() {
                                                        totps.splice(idx, 1);
                                                        localStorage.setItem('totps', JSON.stringify(totps));
                                                        refreshTotps();
                                                    }
                                                })
                                            ])
                                        ]
                                    });
                                    list.appendChild(container);
                                });
                                updateTotpCodes();
                            }

                            async function updateTotpCodes() {
                                if (document.hidden) return;
                                for (let i = 0; i < totps.length; i++) {
                                    try {
                                        const { otp, expires } = totpGenerator.generate(totps[i].secret);
                                        const el = document.getElementById("totpCode" + i);
                                        if (el) el.textContent = otp;

                                        if (el) {
                                            let now = Date.now();
                                            let secondsLeft = Math.max(0, Math.round((expires - now) / 1000));
                                            el.parentElement.parentElement.style.setProperty('--totp-progress', (secondsLeft / 30));
                                        }
                                    } catch (e) {
                                        const el = document.getElementById("totpCode" + i);
                                        if (el) el.textContent = "Error";
                                    }
                                }
                            }

                            setInterval(updateTotpCodes, 1000);

                            function addTotp(form) {
                                const label = form.totpLabel.value.trim();
                                const secret = form.totpSecret.value.trim().replace(/\s+/g, '');
                                if (label && secret) {
                                    totps.push({ label, secret });
                                    localStorage.setItem('totps', JSON.stringify(totps));
                                    form.reset();
                                    form.style.display = "none";
                                    refreshTotps();
                                }
                            }

                            document.getElementById('totpAddBtn').onclick = () => {
                                document.getElementById('totpForm').style.display = "block";
                            };

                            refreshTotps();
                        </script>
                        <style>
                            #totpList .tokenValue {
                                font-family: monospace;
                                font-size: 2em;
                                color: var(--color);
                                letter-spacing: 2px;
                            }

                            #totpList {
                                overflow: auto;
                            }

                            #totpList .tokenContainer {
                                position: relative;
                            }

                            #totpList .tokenContainer::before {
                                content: "";
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: var(--elevate);
                                opacity: 0.6;
                                transform-origin: left;
                                transform: scaleX(var(--totp-progress, 1));
                                transition: transform 1s linear;
                                pointer-events: none;
                                z-index: 0;
                            }

                            #totpList .tokenContainer > * {
                                position: relative;
                                z-index: 1;
                            }

                            #totpList .tokenTitle {
                                font-size: small;
                                color: var(--surface-8);
                            }

                            #totpList .tokenValue {
                                position: relative;
                                overflow: visible;
                            }
                        </style>
                    </ls-tab>
                </ls-tabs>
            </div>
        </div>

    </div>

</body>
</html>